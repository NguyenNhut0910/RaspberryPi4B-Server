{% extends "base.html" %}

{% set current_page = 'data' %}

{% block title %}Trang chủ - Raspberry Pi Server{% endblock %}

{% block page_title %}

{% endblock %}

{% block hero %}
<!-- Hero Section -->

{% endblock %}

{% block content %}
<style>
    .widget-chart-md {
        height: 190px;
    }

    /* Modal Select Run Styles */
    /* #modalSelectRun .table {
        margin-bottom: 0;
    }

    #modalSelectRun .table thead th {
        background: linear-gradient(135deg, 
            rgba(var(--bs-primary-rgb), 0.1) 0%, 
            rgba(var(--bs-primary-rgb), 0.05) 100%);
        color: var(--bs-emphasis-color);
        font-weight: var(--font-weight-semibold);
        border-bottom: 2px solid rgba(var(--bs-primary-rgb), 0.2);
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
    }

    #modalSelectRun .table tbody tr {
        transition: all 0.2s ease;
    }

    #modalSelectRun .table tbody tr:hover {
        background: linear-gradient(135deg, 
            rgba(var(--bs-primary-rgb), 0.05) 0%, 
            rgba(var(--bs-primary-rgb), 0.02) 100%);
        transform: translateX(2px);
    }

    #modalSelectRun .table tbody tr.table-active {
        background: linear-gradient(135deg, 
            rgba(var(--bs-primary-rgb), 0.15) 0%, 
            rgba(var(--bs-primary-rgb), 0.08) 100%);
        box-shadow: inset 3px 0 0 var(--bs-primary);
    }

    #modalSelectRun .table tbody td {
        padding: 0.75rem 0.5rem;
        vertical-align: middle;
        font-size: 0.875rem;
    } */

    #modalSelectRun .form-check-input {
        cursor: pointer;
    }

    #modalSelectRun .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }

    .select-box {
        position: relative;
        cursor: pointer;
        padding: 0.625rem 2.5rem 0.625rem 0.75rem;
        border: 2px solid var(--bs-border-color);
        border-radius: var(--border-radius-md);
        background: white;
        transition: all 0.3s ease;
        display: block;
        text-decoration: none;
        color: var(--bs-body-color);
    }

    .select-box:not(.selected) {
        color: var(--bs-secondary-color);
    }

    .select-box.selected {
        border-color: var(--bs-primary);
        background: linear-gradient(135deg, 
            rgba(var(--bs-primary-rgb), 0.08) 0%, 
            rgba(var(--bs-primary-rgb), 0.03) 100%);
        color: var(--bs-primary);
        font-weight: var(--font-weight-semibold);
    }

    .select-box:hover {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
    }

    .select-box.right-arrow::after {
        content: '\f054';
        font-family: 'Font Awesome 5 Pro';
        font-weight: 400;
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--bs-primary);
        opacity: 0.6;
        transition: all 0.3s ease;
    }

    .select-box:hover.right-arrow::after {
        opacity: 1;
        right: 0.5rem;
    }
</style>

<div class="modal fade modal-slide-top" id="modalSelectRun" tabindex="-1" aria-labelledby="modalSelectRunLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="modalSelectRunLabel">
                    <i class="fas fa-play-circle"></i>
                    Chọn lần chạy
                </h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filter Section -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label for="filterStartDate" class="form-label fw-semibold">
                            <i class="far fa-calendar-alt me-2"></i>Ngày bắt đầu
                        </label>
                        <input type="date" class="form-control" id="filterStartDate">
                    </div>
                    <div class="col-md-3">
                        <label for="filterEndDate" class="form-label fw-semibold">
                            <i class="far fa-calendar-check me-2"></i>Ngày kết thúc
                        </label>
                        <input type="date" class="form-control" id="filterEndDate">
                    </div>
                    <div class="col-md-4">
                        <label for="filterRecipe" class="form-label fw-semibold">
                            <i class="far fa-file-alt me-2"></i>Công thức
                        </label>
                        <select class="form-select" id="filterRecipe">
                            <option value="">Tất cả công thức</option>
                            <option value="recipe1">CIP Standard Cleaning</option>
                            <option value="recipe2">CIP Heavy Duty</option>
                            <option value="recipe3">CIP Light Clean</option>
                            <option value="recipe4">CIP Sanitization</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary w-100" id="btnFilterRuns">
                            <i class="fas fa-search me-2"></i>Tìm kiếm
                        </button>
                    </div>
                </div>

                <!-- Results Table -->
                <div class="glass-container p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="far fa-list-alt me-2"></i>Kết quả tìm kiếm
                            <span class="badge bg-primary ms-2" id="resultCount">0</span>
                        </h6>
                        <small class="text-muted">Chọn một dòng để xem chi tiết</small>
                    </div>
                    
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover align-middle" id="runsTable">
                            <thead class="sticky-top" style="top: 0; z-index: 10;">
                                <tr>
                                    <th style="width: 50px;">
                                        <input class="form-check-input" type="radio" name="selectRunRadio" id="radioHeader" disabled>
                                    </th>
                                    <th style="width: 80px;">ID</th>
                                    <th>Công thức</th>
                                    <th>Thời gian bắt đầu</th>
                                    <th>Thời gian kết thúc</th>
                                    <th>Thời lượng</th>
                                    <th>Số bước</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody id="runsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-5">
                                        <i class="far fa-inbox fa-3x mb-3 d-block"></i>
                                        <p class="mb-0">Chọn điều kiện lọc và nhấn Tìm kiếm</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Selected Run Info -->
                <div class="mt-4" id="selectedRunInfo" style="display: none;">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-info-circle fs-4 me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Lần chạy đã chọn</h6>
                            <p class="mb-0" id="selectedRunText"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmSelectRun" disabled>
                    <i class="fas fa-check me-2"></i>Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid p-0">
    <div class="row">

        <div class="col-3 glass-container rounded-0 p-0 m-0" style="position: sticky; top: 70px; height: calc(100vh - 70px);">
            <div class="card card-1 h-100 rounded-0 mb-4">
                <div class="card-body d-flex flex-column py-4">

                    <div class="d-flex align-items-center mb-3">
                        <i class="fal fa-filter me-3 fs-4"></i>
                        <h5 class="mb-0">Lọc dữ liệu</h5>
                    </div>
                    <p class="text-muted fw-bold mb-2">Lần chạy</p>
                    <a id="selectRun" class="select-box right-arrow form-select mb-3">
                        Chọn lần chạy
                    </a>

                    <p class="text-muted fw-bold mb-2">Bước</p>
                    <select id="selectStep" class="form-select">
                        <option value="">Chọn bước</option>
                        <option value="" selected>Tất cả</option>
                    </select>

                    <div class="mt-3">
                        <p class="text-muted fw-bold mb-2">Trường dữ liệu</p>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">pH</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">conductor</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">pressure</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">TT1</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">TT2</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">TT3</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">TCV</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" checked>
                            <label class="form-check-label">CM1</label>
                        </div>
                    </div>

                    <div class="mt-3">
                        <p class="text-muted fw-bold mb-2">Thao tác</p>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-primary me-3">
                                <i class="fas fa-file-pdf me-2"></i> Tải PDF
                            </button>
                            <button class="btn btn-sm btn-outline-success">
                                <i class="fas fa-file-excel me-2"></i> Tải Excel
                            </button>
                        </div>
                    </div>

                    <hr class="my-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fal fa-info-circle me-3 fs-4"></i>
                        <h5 class="mb-0">Thông tin</h5>
                    </div>

                    <div class="row">
                        <div class="col-auto">
                            <p>Công thức</p>
                            <p>Tổng thời gian chạy</p>
                            <p>Thời gian bắt đầu</p>
                            <p>Thời gian kết thúc</p>
                            <p>Số bước</p>
                        </div>
                        <div class="col">
                            <p>---</p>
                            <p>---</p>
                            <p>---</p>
                            <p>---</p>
                            <p>---</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-9 p-4">
            <div class="row gy-4">

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">pH</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-ph"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">Conductor</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-conductor"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">Pressure</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-pressure"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">TT1</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-tt1"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">TT2</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-tt2"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">TT3</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-tt3"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">TCV</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-tcv"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-4">
                    <div class="card card-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <h5 class="mb-0 me-2">CM1</h5>
                                <span class="text-muted" id="ph-value"></span>
                            </div>
                            <div class="widget-chart-md">
                                <canvas id="chart-cm1"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<script src="{{url_for('static', filename='js/SensorChart.js')}}"></script>
<script>
    // Mock data for testing
    const MOCK_RUNS = [
        {
            id: 'RUN001',
            recipe: 'CIP Standard Cleaning',
            recipeId: 'recipe1',
            startTime: '2025-10-14 08:00:00',
            endTime: '2025-10-14 10:30:00',
            duration: '2h 30m',
            steps: 8,
            status: 'completed'
        },
        {
            id: 'RUN002',
            recipe: 'CIP Heavy Duty',
            recipeId: 'recipe2',
            startTime: '2025-10-14 11:00:00',
            endTime: '2025-10-14 14:45:00',
            duration: '3h 45m',
            steps: 12,
            status: 'completed'
        },
        {
            id: 'RUN003',
            recipe: 'CIP Light Clean',
            recipeId: 'recipe3',
            startTime: '2025-10-13 09:15:00',
            endTime: '2025-10-13 10:30:00',
            duration: '1h 15m',
            steps: 5,
            status: 'completed'
        },
        {
            id: 'RUN004',
            recipe: 'CIP Sanitization',
            recipeId: 'recipe4',
            startTime: '2025-10-13 14:00:00',
            endTime: '2025-10-13 15:30:00',
            duration: '1h 30m',
            steps: 6,
            status: 'completed'
        },
        {
            id: 'RUN005',
            recipe: 'CIP Standard Cleaning',
            recipeId: 'recipe1',
            startTime: '2025-10-12 08:00:00',
            endTime: '2025-10-12 10:25:00',
            duration: '2h 25m',
            steps: 8,
            status: 'completed'
        },
        {
            id: 'RUN006',
            recipe: 'CIP Heavy Duty',
            recipeId: 'recipe2',
            startTime: '2025-10-12 13:00:00',
            endTime: '2025-10-12 16:50:00',
            duration: '3h 50m',
            steps: 12,
            status: 'completed'
        },
        {
            id: 'RUN007',
            recipe: 'CIP Light Clean',
            recipeId: 'recipe3',
            startTime: '2025-10-11 10:00:00',
            endTime: '2025-10-11 11:20:00',
            duration: '1h 20m',
            steps: 5,
            status: 'completed'
        },
        {
            id: 'RUN008',
            recipe: 'CIP Standard Cleaning',
            recipeId: 'recipe1',
            startTime: '2025-10-11 15:30:00',
            endTime: '2025-10-11 18:00:00',
            duration: '2h 30m',
            steps: 8,
            status: 'failed'
        },
        {
            id: 'RUN009',
            recipe: 'CIP Sanitization',
            recipeId: 'recipe4',
            startTime: '2025-10-10 09:00:00',
            endTime: '2025-10-10 10:35:00',
            duration: '1h 35m',
            steps: 6,
            status: 'completed'
        },
        {
            id: 'RUN010',
            recipe: 'CIP Heavy Duty',
            recipeId: 'recipe2',
            startTime: '2025-10-10 12:00:00',
            endTime: '2025-10-10 15:40:00',
            duration: '3h 40m',
            steps: 12,
            status: 'completed'
        }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const $selectRun = document.getElementById('selectRun');
        const $selectStep = document.getElementById('selectStep');
        const modalSelectRun = new bootstrap.Modal(document.getElementById('modalSelectRun'), {
            keyboard: false
        });

        // Modal elements
        const $filterStartDate = document.getElementById('filterStartDate');
        const $filterEndDate = document.getElementById('filterEndDate');
        const $filterRecipe = document.getElementById('filterRecipe');
        const $btnFilterRuns = document.getElementById('btnFilterRuns');
        const $runsTableBody = document.getElementById('runsTableBody');
        const $resultCount = document.getElementById('resultCount');
        const $selectedRunInfo = document.getElementById('selectedRunInfo');
        const $selectedRunText = document.getElementById('selectedRunText');
        const $btnConfirmSelectRun = document.getElementById('btnConfirmSelectRun');

        let selectedRun = null;
        let filteredRuns = [];

        // Set default dates (last 7 days)
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        $filterStartDate.value = lastWeek.toISOString().split('T')[0];
        $filterEndDate.value = today.toISOString().split('T')[0];

        // Open modal
        if ($selectRun) {
            $selectRun.addEventListener('click', (e) => {
                modalSelectRun.show();
            });
        }

        // Filter button click
        $btnFilterRuns.addEventListener('click', () => {
            filterRuns();
        });

        // Confirm selection
        $btnConfirmSelectRun.addEventListener('click', () => {
            if (selectedRun) {
                // Update the select box text
                $selectRun.textContent = `${selectedRun.id} - ${selectedRun.recipe}`;
                $selectRun.classList.add('selected');
                
                // TODO: Load data for selected run
                console.log('Selected run:', selectedRun);
                
                // Close modal
                modalSelectRun.hide();
            }
        });

        // Filter runs function
        function filterRuns() {
            const startDate = $filterStartDate.value;
            const endDate = $filterEndDate.value;
            const recipeFilter = $filterRecipe.value;

            filteredRuns = MOCK_RUNS.filter(run => {
                const runDate = run.startTime.split(' ')[0];
                
                // Check date range
                let dateMatch = true;
                if (startDate && runDate < startDate) dateMatch = false;
                if (endDate && runDate > endDate) dateMatch = false;
                
                // Check recipe
                let recipeMatch = true;
                if (recipeFilter && run.recipeId !== recipeFilter) recipeMatch = false;
                
                return dateMatch && recipeMatch;
            });

            renderRunsTable();
        }

        // Render table
        function renderRunsTable() {
            if (filteredRuns.length === 0) {
                $runsTableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-5">
                            <i class="far fa-search fa-3x mb-3 d-block"></i>
                            <p class="mb-0">Không tìm thấy lần chạy nào phù hợp</p>
                        </td>
                    </tr>
                `;
                $resultCount.textContent = '0';
                return;
            }

            $resultCount.textContent = filteredRuns.length;
            
            $runsTableBody.innerHTML = filteredRuns.map((run, index) => {
                const statusBadge = run.status === 'completed' 
                    ? '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Hoàn thành</span>'
                    : '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Thất bại</span>';
                
                return `
                    <tr class="run-row" data-index="${index}" style="cursor: pointer;">
                        <td>
                            <input class="form-check-input" type="radio" name="selectRunRadio" 
                                   id="radio${index}" value="${run.id}">
                        </td>
                        <td><strong>${run.id}</strong></td>
                        <td>
                            <i class="far fa-file-alt text-primary me-2"></i>
                            ${run.recipe}
                        </td>
                        <td>
                            <i class="far fa-clock text-muted me-1"></i>
                            ${run.startTime}
                        </td>
                        <td>
                            <i class="far fa-clock text-muted me-1"></i>
                            ${run.endTime}
                        </td>
                        <td>
                            <span class="badge bg-primary-subtle text-primary">
                                ${run.duration}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info-subtle text-info">
                                ${run.steps} bước
                            </span>
                        </td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');

            // Add click events to rows
            document.querySelectorAll('.run-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    if (e.target.type !== 'radio') {
                        const index = row.dataset.index;
                        const radio = row.querySelector('input[type="radio"]');
                        radio.checked = true;
                        selectRun(index);
                    } else {
                        const index = row.dataset.index;
                        selectRun(index);
                    }
                });
            });

            // Add change events to radios
            document.querySelectorAll('input[name="selectRunRadio"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const row = e.target.closest('.run-row');
                    const index = row.dataset.index;
                    selectRun(index);
                });
            });
        }

        // Select run
        function selectRun(index) {
            selectedRun = filteredRuns[index];
            
            // Show selected info
            $selectedRunInfo.style.display = 'block';
            $selectedRunText.innerHTML = `
                <strong>ID:</strong> ${selectedRun.id} | 
                <strong>Công thức:</strong> ${selectedRun.recipe} | 
                <strong>Thời gian:</strong> ${selectedRun.startTime} → ${selectedRun.endTime}
            `;
            
            // Enable confirm button
            $btnConfirmSelectRun.disabled = false;
            
            // Highlight selected row
            document.querySelectorAll('.run-row').forEach(row => {
                row.classList.remove('table-active');
            });
            document.querySelector(`.run-row[data-index="${index}"]`).classList.add('table-active');
        }

        // Reset modal on close
        document.getElementById('modalSelectRun').addEventListener('hidden.bs.modal', () => {
            selectedRun = null;
            $selectedRunInfo.style.display = 'none';
            $btnConfirmSelectRun.disabled = true;
            document.querySelectorAll('input[name="selectRunRadio"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('.run-row').forEach(row => {
                row.classList.remove('table-active');
            });
        });
    });


    const ids = ['chart-ph', 'chart-conductor', 'chart-pressure', 'chart-tt1', 'chart-tt2', 'chart-tt3', 'chart-tcv', 'chart-cm1'];
    const charts = {};
    ids.forEach(id => {
        charts[id] = new SensorChart('#' + id, {
            options: {
                label: id.replace('chart-', '').toUpperCase(),
                fillArea: false,
                showLabel: false,
            },
            limitPoints: 20,
            onDataUpdate: (chart) => {
                const lastData = chart.getLastData();
                if (lastData) {
                    document.getElementById(id.replace('chart-', '') + '-value').textContent = lastData.data;
                }
            }
        });
    });
</script>
{% endblock %}