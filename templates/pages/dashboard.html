{% extends "base.html" %}

{% set current_page = 'home' %}

{% block title %}Trang chủ - Raspberry Pi Server{% endblock %}

{% block page_title %}
<i class="far fa-house me-2"></i>Dashboard
{% endblock %}

{% block hero %}
<!-- Hero Section -->

{% endblock %}

{% block content %}
<div class="container-fluid">

    <div class="row px-2 py-3">

        <div class="col-9">
            <div class="card card-1" style="height: 690px;">
                <div class="card-body d-flex justify-content-center align-items-center">
                    <!-- <img style="height: 650px; max-height: 100%; max-width: 100%;"
                        src="{{url_for('static', filename='img/tank.png')}}" alt=""> -->
                    {% include 'partials/tank.html' %}
                </div>
            </div>
        </div>

        <div class="col-3">

            <div class="card card-1 mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-around align-items-center">
                        <div class="d-flex flex-column align-items-center">
                            <button class="btn btn-1 rounded-pill mb-1">
                                <i class="fal fa-hand-pointer"></i>
                            </button>
                            <small>Thủ công</small>
                        </div>
                        <div class="d-flex flex-column align-items-center">
                            <button class="btn btn-1 rounded-pill mb-1">
                                <i class="fal fa-receipt"></i>
                            </button>
                            <small>Công thức</small>
                        </div>
                        <div class="d-flex flex-column align-items-center">
                            <button class="btn btn-1 rounded-pill mb-1">
                                <i class="fal fa-cog"></i>
                            </button>
                            <small>Cấu hình</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card card-1 mb-4">
                <div class="card-header bg-primary-subtle bg-gradient d-flex align-items-center border-0">
                    <i class="fal fa-info-circle me-3 fs-4"></i>
                    <h5 class="mb-0">Trạng thái</h5>
                </div>
                <div class="card-body">
                    <div class="widget-content align-items-center" style="min-height: 200px;">
                        <span class="fs-1 text-muted">
                            <!-- <i class="fi fi-tr-drawer-empty"></i> -->
                            <i class="fal fa-ellipsis-h-alt"></i>
                        </span>
                        <span class="text-muted">Hệ thống đang chờ hoạt động</span>
                    </div>
                </div>
            </div>

            <div class="card card-1 mb-4">
                <div class="card-header bg-warning-subtle bg-gradient d-flex align-items-center border-0">
                    <i class="fal fa-exclamation-triangle fs-4 me-3"></i>
                    <h5 class="mb-0">Cảnh báo</h5>
                    <i class="fas fa-chevron-right ms-auto"></i>
                </div>
                <div class="card-body">
                    <div class="widget-content align-items-center" style="min-height: 200px;">
                        <span class="fs-1 text-muted">
                            <!-- <i class="fi fi-tr-drawer-empty"></i> -->
                            <i class="fal fa-ellipsis-h-alt"></i>
                        </span>
                        <span class="text-muted">Không có cảnh báo</span>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <div class="row px-2 py-3 mb-4">
        <div class="col-6">
            <div class="card card-1">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <h5 class="mb-0 me-2">pH-10101</h5>
                        <span class="text-muted" id="ph-value"></span>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="chart-ph"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card card-1">
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <h5 class="mb-0 me-2">CT-10101</h5>
                        <span class="text-muted" id="ct-value"></span>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="chart-ct"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{url_for('static', filename='js/SensorChart.js')}}"></script>
<script>
    // Initialize charts
    const phChart = new SensorChart('chart-ph', {
        options: {
            label: 'pH Value',
            fillArea: false,
            showLabel: false,
        },
        limitPoints: 20,
        onDataUpdate: (chart) => {
            const lastData = chart.getLastData();
            if (lastData) {
                document.getElementById('ph-value').textContent = lastData.data;
            }
        }
    });

    // Chart thứ 2 không hiển thị legend
    const ctChart = new SensorChart('chart-ct', {
        options: {
            label: 'CT Value',
            fillArea: false,
            showLabel: false,
        },
        limitPoints: 20,
        onDataUpdate: (chart) => {
            const lastData = chart.getLastData();
            if (lastData) {
                document.getElementById('ct-value').textContent = lastData.data + ' mS/cm';
            }
        }
    });
</script>

<script>
    function autoScaleTank() {
        const tankContainer = document.getElementById('ID_TopLevelScreenWindow');
        const containerWidth = tankContainer.parentElement.clientWidth;
        const containerHeight = tankContainer.parentElement.clientHeight;
        const width = 1210;
        const height = 695;
        const scaleX = containerWidth / width;
        const scaleY = containerHeight / height;
        const scale = Math.min(scaleX, scaleY);
        
        // Đặt transform-origin về góc trên-trái để dễ tính toán
        tankContainer.style.transformOrigin = '0 0';
        tankContainer.style.transform = `scale(${scale})`;
        
        // Tính toán vị trí để căn giữa
        const scaledWidth = width * scale;
        const scaledHeight = height * scale;
        const leftOffset = (containerWidth - scaledWidth) / 2;
        const topOffset = (containerHeight - scaledHeight) / 2;
        
        tankContainer.style.left = `${leftOffset}px`;
        tankContainer.style.top = `${topOffset}px`;
    }
    setInterval(autoScaleTank, 100);
</script>

<!-- <script>
    function sample_data(min, max, decimals = 2) {
        const now = new Date();
        const label = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0') + ':' + now.getSeconds().toString().padStart(2, '0');
        const value = (Math.random() * (max - min) + min).toFixed(decimals);
        return { label, value };
    }

    setInterval(() => {
        const phPoint = sample_data(5.5, 5.6)
        phChart.addDataPoint(phPoint.label, phPoint.value);

        // Tạo data cho CT chart
        const ctValue = sample_data(2.5, 2.6)
        ctChart.addDataPoint(phPoint.label, ctValue.value);
    }, 2000);
</script> -->
{% endblock %}